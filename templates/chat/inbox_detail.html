{% extends "partials/base.html" %}
{% load static %}
{% block content %}

        <!-- Main Contents -->
        <div class="main_content">

            <span uk-toggle="target: .message-content;" class="fixed left-0 top-36 bg-red-600 z-10 py-1 px-4 rounded-r-3xl text-white"> Users</span>

            <div class="messages-container">
                <div class="messages-container-inner">


                    <div class="messages-inbox">
                        <div class="messages-headline">
                            <div class="input-with-icon" hidden>
                                <input id="autocomplete-input" type="text" placeholder="Search">
                                <i class="icon-material-outline-search"></i>
                            </div>
                            <h2 class="text-2xl font-semibold">Chats</h2>
                            <span class="absolute icon-feather-edit mr-4 text-xl uk-position-center-right cursor-pointer"></span>
                        </div>
                        <div class="messages-inbox-inner" data-simplebar>
                            <ul>
                                {% for m in message_list %}
                                {% if request.user == m.chat_receiver %}
                                    <li>
                                        <a href="#">
                                            <div class="message-avatar"><i class="status-icon status-online"></i><img src="{{m.chat_sender.profile.image.url}}" alt=""></div>

                                            <div class="message-by">
                                                <div class="message-by-headline">
                                                    <h5>{{m.chat_sender.profile.full_name}}</h5>
                                                    <span style="font-size: 9px;">{{m.date|timesince}} ago</span>
                                                </div>
                                                <p>{{m.message}}</p>
                                            </div>
                                        </a>
                                    </li>
                                {% endif %}
                                {% empty %}
                                    <li>
                                        <a href="#">
                                            <div class="message-by">
                                                <div class="message-by-headline">
                                                    <h5>No Message Yet</h5>
                                                </div>
                                            </div>
                                        </a>
                                    </li>
                                {% endfor %}

                            </ul>
                        </div>
                    </div>


                    <div class="message-content">

                        <div class="messages-headline">
                            <div class="flex">
                                <img class="mr-1" src="{{receiver_detail.profile.image.url}}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 50%;" alt="">
                                <h4 class="ml-1"> {{receiver_detail.profile.full_name|title}} </h4>
                            </div>
                            {% if receiver_detail in request.user.profile.friends.all %}
                                <a href="#" id="block-user-btn" data-block-user="{{receiver_detail.id}}" class="message-action text-red-500 "><i class="fas fa-ban"></i> <span class="md:inline hidden block-text{{receiver_detail.id}}" > Block {{ receiver_detail.profile.full_name|title }} </span> </a>
                            {% endif %}
                        </div>

                        <div class="message-content-scrolbar" data-simplebar>

                            <!-- Message Content Inner -->
                            <div class="message-content-inner chat_container">
                                <!-- Time Sign -->
                                {% comment %} <div class="message-time-sign">
                                    <span>28 June, 2020</span>
                                </div> {% endcomment %}
                                {% for m in message_detail %}
                                    {% if m.chat_sender == request.user %}
                                    <div class="message-bubble me">
                                        <div class="message-bubble-inner">
                                            <div class="message-avatar"><img src="{{m.chat_sender.profile.image.url}}" alt=""></div>
                                            <div class="message-text">
                                                <p>{{m.message}}</p>
                                                {% comment %} <p style="font-size: 11px; color: white">{{m.date|timesince}} ago</p> {% endcomment %}
                                            </div>
                                        </div>
                                        <div class="clearfix"></div>
                                    </div>
                                    {% else %}
                                    <div class="message-bubble">
                                        <div class="message-bubble-inner">
                                            <div class="message-avatar"><img src="{{m.chat_sender.profile.image.url}}" alt=""></div>
                                            <div class="message-text">
                                                <p>{{m.message}}</p>
                                                {% comment %} <p style="font-size: 11px; color: gray">{{m.date|timesince}} ago</p> {% endcomment %}
                                            </div>
                                        </div>
                                        <div class="clearfix"></div>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                                <div id="chat-messages"></div>
                            </div>
                            <!-- Message Content Inner / End -->

                            <!-- Reply Area -->
                            <div class="message-reply">
                                <textarea id="chat-input" cols="1" rows="1" placeholder="Write Message"></textarea>
                                <button id="send-btn" class="button ripple-effect">Send</button>
                            </div> 
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        var receiver = null
        var receiver_id = "{{chat_receiver.username}}"
        var logged_in = "{{request.user.username}}"
        const pathname = window.location.pathname

        const parts = pathname.split("/")
        const username = parts[parts.length-2]
        console.log(username);

        if(receiver_id === logged_in){
            receiver = receiver_id
        } else {
            receiver = receiver_id
        }

        var socket = new WebSocket("ws://" + window.location.host + "/ws/chat/" + receiver + "/")

        socket.onopen = function(){
            console.log("WebSocket Connection Established");
        }

        socket.onmessage = function(event){
            var data = JSON.parse(event.data)
            var message = data.message;
            var chat_sender = data.chat_sender;
            var profile_image = data.profile_image;
            var chat_receiver = data.chat_receiver;


            if(chat_sender === "{{chat_sender}}"){
                var chatMessage = '<div class="message-bubble me">';
                chatMessage += '<div class="message-avatar"><img src="' + profile_image + '" alt=""></div>';
                chatMessage += '<div class="message-text">';
                chatMessage += '<p>' + message + '</p>';
                chatMessage += '</div>';
                chatMessage += '</div>';
                chatMessage += '<div class="clearfix"></div>';
                chatMessage += '</div>';

                $('#chat-messages').append(chatMessage);
                var chatContainer = document.querySelector(".chat_container")
                chat_container.scrollTop = chat_container.scrollHeight
            } else {
                var chatMessage = '<div class="message-bubble">';
                    chatMessage += '<div class="message-avatar"><img src="' + profile_image + '" alt=""></div>';
                    chatMessage += '<div class="message-text">';
                    chatMessage += '<p>' + message + '</p>';
                    chatMessage += '</div>';
                    chatMessage += '</div>';
                    chatMessage += '<div class="clearfix"></div>';
                    chatMessage += '</div>';

                    $('#chat-messages').append(chatMessage);
                    var chatContainer = document.querySelector(".chat_container")
                    chat_container.scrollTop = chat_container.scrollHeight
            }
        }

        socket.onclose = function(){
            console.log("WebSocket Connection Closed");
        }

        $("#send-btn").on("click", function(){
            let input = $("#chat-input");
            let message = input.val();
            let sender = "{{request.user.username}}";
            var data = {
                'message': message,
                'chat_sender': sender,
                'chat_receiver': username,
            };
            socket.send(JSON.stringify(data));
            input.val('');
            var sendButton = $("#send-btn");
            sendButton.prop("disabled", true);
            $(".chat_container").scrollTop(10000000000000000);
        })

        $(document).ready(function() {
            $(".chat_container").scrollTop(100000000000);
            });
    </script>
    <script>
        $(document).ready(function() {
             var chatInputValue = $('#chat-input');
             var sendButton = $('#send-btn');
 
             // Disable the button initially
             sendButton.prop('disabled', true);
 
             // Check input field on keyup event
             chatInputValue.on('keyup', function() {
                 var inputText = $(this).val();
 
                 // Enable/disable button based on input field value
                 if (inputText.trim() !== '') {
                     sendButton.prop('disabled', false);
                 } else {
                     sendButton.prop('disabled', true);
                 }
             });
         })
     </script>

    {% endblock content %}